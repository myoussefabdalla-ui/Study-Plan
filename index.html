<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Study Planner</title>
 
<!-- SheetJS for Excel save/load -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/myoussefabdalla-ui/Study-Plan@main/courses_core1.js?v=2"></script>
<script src="https://cdn.jsdelivr.net/gh/myoussefabdalla-ui/Study-Plan@main/courses_core2.js?v=2"></script>
<script src="https://cdn.jsdelivr.net/gh/myoussefabdalla-ui/Study-Plan@main/courses_elecgen.js?v=2"></script>
<script src="https://cdn.jsdelivr.net/gh/myoussefabdalla-ui/Study-Plan@main/courses_elec1.js?v=2"></script>
<script src="https://cdn.jsdelivr.net/gh/myoussefabdalla-ui/Study-Plan@main/courses_elec3.js?v=2"></script>
<script src="https://cdn.jsdelivr.net/gh/myoussefabdalla-ui/Study-Plan/courses_fundamental.js"></script>
<script src="https://cdn.jsdelivr.net/gh/myoussefabdalla-ui/Study-Plan/courses_full.js?v=2"></script>
<script src="https://cdn.jsdelivr.net/gh/myoussefabdalla-ui/Study-Plan/default_plans.js"></script>
  
<style>
  :root{
    --sidebar-w:320px;
    --gap:12px;
    --font: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  }
  body{
    margin:0;
    font-family:var(--font);
    display:flex;
    height:100vh;
    background:#f6f8fb;
  }
  main{
    flex:1;
    padding:16px;
    box-sizing:border-box;
    overflow:auto;
  }
  header{
    display:flex;
    gap:12px;
    align-items:center;
    margin-bottom:12px;
  }
  header h1{ margin:0; font-size:24px; }
  .controls{ margin-left:auto; display:flex; gap:8px; align-items:center; }
  button,input{ padding:8px 10px; border-radius:6px; border:1px solid #cfd8e3; background:white; cursor:pointer; }
  .layout{ display:flex; gap:12px; align-items:flex-start; }

  .site-footer {
  background: #f1f5f9; /* light grey-blue */
  padding: 16px;
  text-align: left;
  font-size: 13px;
  color: #334155; /* slate */
  border-top: 1px solid #cbd5e1;
  margin-top: 20px;
}

.site-footer .disclaimer {
  font-size: 14px;
  color: #475569; /* slightly darker slate */
  margin-top: 8px;
  line-height: 1.5;
}

  /* semesters grid */
  .semesters{
    display:grid;
    grid-template-columns: repeat(2, minmax(280px, 1fr));
    gap:12px;
    width:100%;
  }
  .semester{
    background:linear-gradient(180deg,#fff,#fbfdff);
    border-radius:10px;
    padding:10px;
    min-height:120px;
    box-shadow:0 1px 4px rgba(20,30,60,0.05);
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .semester.over{ outline:3px dashed rgba(59,130,246,0.18); background:rgba(59,130,246,0.02); }
  .semesterHeader{ display:flex; justify-content:space-between; align-items:center; gap:8px; }
  .semesterTitle{ font-weight:700; font-size:14px; }
  .creditsBadge{ font-size:13px; padding:4px 8px; border-radius:999px; background:#eef2ff; color:#1e3a8a; }
  .creditsBadge.over{ background:#fee2e2; color:#7f1d1d; font-weight:700; border:1px solid #dc2626; }

  .slot{ flex:1; display:flex; flex-direction:column; gap:8px; overflow:auto; padding:6px; }
  /* course card */
  .courseCard{
    display:flex;
    gap:8px;
    align-items:center;
    border-radius:8px;
    padding:8px;
    color:white;
    cursor:grab;
    user-select:none;
    box-shadow:0 1px 2px rgba(0,0,0,0.04);
  }
  .courseCode{ font-weight:700; font-size:13px; }
  .courseMeta{ font-size:12px; opacity:0.95; }
  .coursePrereq{ font-size:11px; opacity:0.9; margin-top:4px; color:rgba(255,255,255,0.85); }

  /* category colors */

  
  .cat-ProgramRequirement{ background:linear-gradient(180deg,#7c3aed,#5b21b6); }

  /* University Requirement courses: yellow */
.cat-UniversityRequirement { 
  background: linear-gradient(180deg, #facc15, #ca8a04); /* bright yellow → golden yellow */
  color: black; /* makes text more readable on yellow */
}

/* Fundamental courses: green */
.cat-Fundamental {
  background: linear-gradient(180deg, #22c55e, #166534); /* light green → dark green */
  color: white; /* white text pops well on green */
}
/* Core courses: blue */
.cat-Core {
  background: linear-gradient(180deg, #3b82f6, #1e3a8a); /* bright blue → navy */
  color: white;
}
/* Other Department courses: grey */
.cat-OtherDept {
  background: linear-gradient(180deg, #9ca3af, #374151); /* light grey → dark grey */
  color: white; /* ensures contrast on darker grey */
}
.cat-FacultyRequirement {
  background: linear-gradient(180deg, #ef4444, #7f1d1d); /* bright red to dark red */
}


  /* sidebar */
  aside.sidebar{
  width:var(--sidebar-w);
  padding:16px;
  box-sizing:border-box;
  border-left:1px solid #e6eef8;
  background:linear-gradient(180deg,#fbfdff,#f9fbff);

  position: sticky;   /* key part */
  top: 0;             /* stick to top of viewport */
  align-self: flex-start;
  height: 100vh;      /* full height so it doesn’t shrink */
  overflow-y: auto;   /* scroll inside the sidebar if too long */
  }

  .sidebar h2{ margin:0 0 8px 0; font-size:16px; }
  .courseList{ display:flex; flex-direction:column; gap:8px; max-height:70vh; overflow:auto; padding-bottom:12px; }

  .msg{ margin-top:8px; padding:10px; border-radius:8px; font-size:14px; display:none; }
  .msg.error{ background:#fee2e2; color:#7f1d1d; border:1px solid #dc2626; font-weight:700; }
  .msg.ok{ background:#ecfeff; color:#064e3b; border:1px solid #14b8a6; }

  .tooltip{
    position:absolute;
    background:white;
    border:1px solid #cbd5e1;
    box-shadow:0 4px 12px rgba(0,0,0,0.15);
    padding:10px;
    border-radius:8px;
    font-size:13px;
    max-width:300px;
    z-index:100;
    display:none;
  }
</style>
</head>
<body>
<main>
  <header>
    <!-- Left logo -->
    <img src="univ_logo.jpg" alt="Left Logo" class="logo left">
    <h1>Study Plan — Electronics & Comm., Faculty of Eng., Cairo University</h1>
    <div class="controls">
      <label>Max credits:
        <input id="maxCredits" type="number" min="6" value="21" style="width:90px"/>
      </label>
      <button id="saveExcelBtn">Save Excel</button>
      <button id="loadExcelBtn">Load Excel</button>
      <button id="savePdfBtn">Save PDF</button>
      <input type="file" id="fileInput" accept=".xlsx,.xls"/>
      <button id="resetBtn" style="background:#fee2e2;border-color:#fecaca">Reset</button>
    </div>
    <div id="totalCreditsDisplay" 
     style="font-size:18px; font-weight:bold; margin-left:20px;">
    Total Credits: 0
    </div>
    <!-- Right logo -->
    <img src="fac_logo.jpg" alt="Right Logo" class="logo right">

  <label>Default Plan:
  <select id="defaultPlanSelect">
    <option value="8">8 Semesters</option>
    <option value="9">9 Semesters</option>
    <option value="10" selected>10 Semesters</option>
  </select>
  </label>

  </header>

  <div class="layout">
    <section style="flex:1;">
      <div class="semesters" id="semestersContainer"></div>
      <section id="programWarnings" class="msg error" style="display:none; margin-top:12px;"></section>
      <footer class="muted">Drag courses from the right into any semester. Double-click to remove. Errors show if prerequisites are missing or credits exceeded.</footer>
    </section>

<aside class="sidebar">
  <h2>All Courses</h2>

  <!-- Category filter -->
  <label for="categorySelect"><b>Filter by Category:</b></label>
  <select id="categorySelect">
    <option value="ALL">All</option>
    <option value="Fundamental">Fundamental</option>
    <option value="UniversityRequirement">University Requirement</option>
    <option value="Core">Core</option>
    <option value="FacultyRequirement">Faculty Requirement</option>
    <option value="ProgramRequirement">Program Requirement</option>
    <option value="OtherDept">Other Depts.</option>
  </select>

  <div class="courseList" id="courseList"></div>
  <div id="message" class="msg"></div>
</aside>

  </div>
  <footer class="site-footer">
  <p>&copy; Dr. Mohamed Youssef</p>
  <p class="disclaimer">
    This webpage was created to help Electronics & Communication Students at the Faculty of Engineering, Cairo University generate their study plan. 
    Students are responsible to review their program requirements and consult with their academic faculty advisors and administrators.
  </p>
</footer>

</main>

<div id="tooltip" class="tooltip"></div>

<script>
const CATEGORY_ORDER = {
  "Fundamental": 1,
  "UniversityRequirement": 2,
  "Core": 3,
  "FacultyRequirement": 4,
  "ProgramRequirement": 5,
  "OtherDept": 6
};

/* -------------------
   State
   ------------------- */
let NUM_SEM = 10;
let plan = Array.from({length:NUM_SEM}, ()=>[]);
let courseMap = Object.fromEntries(COURSES.map(c=>[c.code,c]));
let maxCredits = parseInt(document.getElementById('maxCredits').value,10) || 21;

/* -------------------
   Total Credits Tracker
   ------------------- */
const DEGREE_REQUIREMENT = 156;  // change this to your real program requirement
function updateTotalCredits() {
  let totalCredits = 0;

  plan.forEach(sem => {
    sem.forEach(code => {
      totalCredits += courseMap[code]?.credits || 0;
    });
  });

  const display = document.getElementById('totalCreditsDisplay');
  display.textContent = `Total Credits: ${totalCredits}`;

  if (totalCredits >= DEGREE_REQUIREMENT) {
    display.style.color = "green";
  } else {
    display.style.color = "red";
  }
}


/* DOM refs */
const semContainer=document.getElementById('semestersContainer');
const courseList=document.getElementById('courseList');
const msgEl=document.getElementById('message');
const tooltip=document.getElementById('tooltip');
const warnEl=document.getElementById('programWarnings');

/* -------------------
   Rendering
   ------------------- */
function renderSemesters(){
  semContainer.innerHTML='';
  for(let i=0;i<NUM_SEM;i++){
    const sem=document.createElement('div');
    sem.className='semester';
    sem.dataset.sem=i+1;
    sem.ondragover=allowDrop;
    sem.ondrop=handleDrop;
    sem.innerHTML=`
      <div class="semesterHeader">
        <div class="semesterTitle">Semester ${i+1}</div>
        <div class="creditsBadge" id="badge-${i+1}">0 credits</div>
      </div>
      <div class="slot" id="slot-${i+1}"></div>
    `;
    semContainer.appendChild(sem);
  }
}
function refreshSemester(semNum){
  const slot=document.getElementById(`slot-${semNum}`);
  slot.innerHTML='';
  (plan[semNum-1]||[]).forEach(code=>{
    const c=courseMap[code];
    if(!c) return;
    const card=makeCourseCard(c,true,semNum);
    slot.appendChild(card);
  });
  updateBadge(semNum);
}
function updateBadge(semNum){
  const total=(plan[semNum-1]||[]).reduce((s,cd)=>s+(courseMap[cd]?.credits||0),0);
  const badge=document.getElementById(`badge-${semNum}`);
  badge.textContent=`${total} credits`;
  if(total>maxCredits) badge.classList.add('over'); else badge.classList.remove('over');
}

function renderCourseList(){
  courseList.innerHTML='';
  const selectedCategory = document.getElementById('categorySelect').value;

  let filtered = COURSES.filter(c => !isCoursePlaced(c.code));

  if(selectedCategory !== "ALL"){
    filtered = filtered.filter(c => c.category === selectedCategory);
  } else {
    // Sort by category order
    filtered.sort((a,b) => {
      return (CATEGORY_ORDER[a.category] || 99) - (CATEGORY_ORDER[b.category] || 99);
    });
  }

  filtered.forEach(c=>{
    const card=makeCourseCard(c,false);
    courseList.appendChild(card);
  });
}

/* -------------------
   Course Cards
   ------------------- */
function makeCourseCard(c,placed=false,semNum=null){
  const card=document.createElement('div');
  card.className=`courseCard cat-${c.category}`;
  card.draggable=true;
  card.dataset.code=c.code;
  card.innerHTML=`<div>
  <div><span class="courseCode">${c.code}</span> - <span class="courseMeta">${c.name}</span></div>
  <div class="coursePrereq">${c.credits}cr • Pre: ${c.prereqs?.length?c.prereqs.join(', '):'None'} • Semester: ${c.semester || 'N/A'}</div>
  </div>`;

  card.addEventListener('dragstart',ev=>{
    ev.dataTransfer.setData('text/plain',(placed?'placed:':'lib:')+c.code);
  });
  card.addEventListener('dblclick',()=>{ if(placed && confirm(`Remove ${c.code} from Semester ${semNum}?`)){ removeCourseFromSemester(c.code,semNum); } });

  // tooltip
  card.addEventListener('mouseenter',e=>{
    tooltip.innerHTML=`<b>${c.code} — ${c.name}</b><br>${c.description||''}<br><i>${c.textbook||''}</i>`;
    tooltip.style.display='block';
  });
  card.addEventListener('mousemove',e=>{
    tooltip.style.top=(e.pageY+15)+'px';
    tooltip.style.left=(e.pageX+15)+'px';
  });
  card.addEventListener('mouseleave',()=>tooltip.style.display='none');

  return card;
}

/* -------------------
   Drag & Drop
   ------------------- */
function allowDrop(ev){ ev.preventDefault(); ev.currentTarget.classList.add('over'); }
function handleDrop(ev){
  ev.preventDefault();
  const semNum=parseInt(ev.currentTarget.dataset.sem,10);
  const data=ev.dataTransfer.getData('text/plain');
  if(!data) return;
  if(data.startsWith('lib:')) attemptPlaceCourse(data.slice(4),semNum);
  else if(data.startsWith('placed:')){
    const code=data.slice(7);
    const prev=findCourseSemester(code);
    if(prev!==-1) removeCourseFromSemester(code,prev);
    attemptPlaceCourse(code,semNum);
  }
}

function attemptPlaceCourse(code,semNum){
  const c=courseMap[code]; 
  if(!c) return false;

  // --- NEW RULE: Semester Availability ---
  const isOdd = semNum % 2 === 1;  // odd = FALL, even = SPRING
  if(c.semester === "FALL" && !isOdd){
    showMessage(`❌ Cannot add ${c.code}: offered only in FALL semesters.`,true);
    return false;
  }
  if(c.semester === "SPRING" && isOdd){
    showMessage(`❌ Cannot add ${c.code}: offered only in SPRING semesters.`,true);
    return false;
  }
  // BOTH courses are always allowed

  // --- Credit Limit Rule ---
  const currentTotal=(plan[semNum-1]||[]).reduce((s,cd)=>s+(courseMap[cd]?.credits||0),0);
  if(currentTotal+c.credits>maxCredits){
    showMessage(`❌ Cannot add ${c.code}: exceeds max credits (${maxCredits}) in Semester ${semNum}`,true);
    return false;
  }

  // --- Prerequisite Rule ---
  const missing=(c.prereqs||[]).filter(pre=>!isPrereqPlacedBefore(pre,semNum));
  if(missing.length){
    showMessage(`❌ Cannot add ${c.code}: missing prerequisites [${missing.join(', ')}]`,true);
    return false;
  }

  // --- Add course if all checks pass ---
  plan[semNum-1].push(code);
  refreshSemester(semNum);
  renderCourseList();
  checkProgramRequirements();
  updateTotalCredits();
  showMessage(`✅ Added ${c.code} to Semester ${semNum}`,false);
  return true;
}

function removeCourseFromSemester(code,semNum){
  const arr=plan[semNum-1];
  const idx=arr.indexOf(code);
  if(idx!==-1){ arr.splice(idx,1); refreshSemester(semNum); renderCourseList();   updateTotalCredits(); checkProgramRequirements(); }
}
function isCoursePlaced(code){ return plan.some(s=>s.includes(code)); }
function findCourseSemester(code){ for(let i=0;i<NUM_SEM;i++) if(plan[i].includes(code)) return i+1; return -1; }
function isPrereqPlacedBefore(code,targetSem){ for(let s=1;s<targetSem;s++) if(plan[s-1].includes(code)) return true; return false; }

/* -------------------
   Program Requirements
   ------------------- */
function checkProgramRequirements(){
  let uniCount=0, facCount=0; let progCount=0;
  plan.forEach(sem=>{
    sem.forEach(code=>{
      if(courseMap[code]?.category==="UniversityRequirement") uniCount++;
      if(courseMap[code]?.category==="FacultyRequirement") facCount++;
      if(courseMap[code]?.category==="ProgramRequirement") progCount++;
    });
  });

  let warnings=[];
  if(uniCount<3) warnings.push(`⚠️ Student must complete a minimum of 3 courses from the University Requirement courses. Currently: ${uniCount}`);
  if(facCount<1) warnings.push(`⚠️ Student must take at least 1 Faculty Requirement course. Currently: ${facCount}`);
  if(progCount<5) warnings.push(`⚠️ Student must take at least 5 Program Requirement courses. Currently: ${progCount}`);

  if(warnings.length){
    warnEl.style.display='block';
    warnEl.innerHTML=warnings.join("<br>");
  } else {
    warnEl.style.display='none';
  }
}

/* -------------------
   Messages
   ------------------- */
function showMessage(txt,isError){
  msgEl.textContent=txt;
  msgEl.className='msg '+(isError?'error':'ok');
  msgEl.style.display='block';
  setTimeout(()=>msgEl.style.display='none',10000);
}

/* -------------------
   Save/Load Excel
   ------------------- */
function saveToExcel(){
  const rows=[["Semester","Course Code","Course Name","Credits","Prerequisites"]];
  for(let s=1;s<=NUM_SEM;s++){
    (plan[s-1]||[]).forEach(code=>{
      const c=courseMap[code];
      rows.push([`Semester ${s}`,c.code,c.name,c.credits,(c.prereqs||[]).join(', ')]);
    });
  }
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.aoa_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb,ws,"Study Plan");
  const wbout=XLSX.write(wb,{bookType:'xlsx',type:'array'});
  const blob=new Blob([wbout],{type:"application/octet-stream"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='study-plan.xlsx'; a.click();
  URL.revokeObjectURL(url);
}

function loadFromExcel(file) {
  const reader = new FileReader();
  reader.onload = e => {
    const data = new Uint8Array(e.target.result);
    const wb = XLSX.read(data, { type: 'array' });
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const arr = XLSX.utils.sheet_to_json(sheet, { header: 1 });

    // Reset plan
    plan = Array.from({ length: NUM_SEM }, () => []);

    let violations = [];

    // Try placing courses using the same logic as drag & drop
    arr.slice(1).forEach(row => {
      const sem = row[0]?.match(/(\d+)/);
      const code = row[1];
      if (sem && code) {
        const semNum = parseInt(sem[1]);
        if (courseMap[code]) {
          const placed = attemptPlaceCourse(code, semNum);
          if (!placed) {
            violations.push(
              `${code} could not be placed in Semester ${semNum} due to: 
               wrong semester availability, missing prerequisites, 
               or credit overload.`
            );
          }
        }
      }
    });

    // Re-render UI
    renderSemesters();
    for (let s = 1; s <= NUM_SEM; s++) refreshSemester(s);
    renderCourseList();
    checkProgramRequirements();
    updateTotalCredits();

    // Show messages if violations occurred
    if (violations.length) {
      showMessage("⚠️ Issues found:\n" + violations.join("\n"), true);
    } else {
      showMessage("✅ Plan loaded from Excel", false);
    }

    // Reset file input value so the same file can be loaded again
    document.getElementById('fileInput').value = "";
  };
  reader.readAsArrayBuffer(file);
}



/* -------------------
   Reset
   ------------------- */
function resetPlan(){
  if(!confirm("Reset the plan?")) return;
  plan=Array.from({length:NUM_SEM},()=>[]);
  renderSemesters(); renderCourseList();   updateTotalCredits(); checkProgramRequirements();
  showMessage("Plan reset",false);
}

function savePlanToPDF() {
  const element = document.querySelector("main"); // or document.body if you want sidebar too

  const opt = {
    margin:       0.5,
    filename:     'study-plan.pdf',
    image:        { type: 'jpeg', quality: 0.98 },
    html2canvas:  { scale: 2, scrollY: 0 },
    jsPDF:        { unit: 'in', format: 'a4', orientation: 'landscape' }
  };

  // This handles multi-page splitting automatically
  html2pdf().set(opt).from(element).save();
}

document.getElementById('savePdfBtn').addEventListener('click', savePlanToPDF);

/* -------------------
   Init - Default Study Plan
   ------------------- */

function loadDefaultPlan(planChoice) {
  let chosenPlan;
  if (planChoice === "8") {
    chosenPlan = DEFAULT_PLAN_8;
    NUM_SEM = 8;
  } else if (planChoice === "9") {
    chosenPlan = DEFAULT_PLAN_9;
    NUM_SEM = 9;
  } else {
    chosenPlan = DEFAULT_PLAN_10;
    NUM_SEM = 10;
  }

  // Deep copy into `plan`
  plan = JSON.parse(JSON.stringify(chosenPlan));

  // Re-render semesters
  renderSemesters();
  for (let s = 1; s <= NUM_SEM; s++) refreshSemester(s);

  renderCourseList();
  checkProgramRequirements();
  updateTotalCredits();
}

// Handle dropdown changes
document.getElementById('defaultPlanSelect').addEventListener('change', (e) => {
  loadDefaultPlan(e.target.value);
});

// -------------------
// Init (on page load)
// -------------------

// Set the dropdown to 9 semesters by default
document.getElementById('defaultPlanSelect').value = "9";

// Load the default 9-semester plan
loadDefaultPlan("9");

// Other event listeners
document.getElementById('maxCredits').addEventListener('change',()=>{ 
  maxCredits=parseInt(document.getElementById('maxCredits').value,10)||21; 
  for(let s=1;s<=NUM_SEM;s++) updateBadge(s);
});
document.getElementById('saveExcelBtn').addEventListener('click',saveToExcel);
document.getElementById('loadExcelBtn').addEventListener('click',()=>document.getElementById('fileInput').click());
document.getElementById('fileInput').addEventListener('change',ev=>{ if(ev.target.files[0]) loadFromExcel(ev.target.files[0]); });
document.getElementById('resetBtn').addEventListener('click',resetPlan);
document.getElementById('categorySelect').addEventListener('change', renderCourseList);


</script>
</body>
</html>



